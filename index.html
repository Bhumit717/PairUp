<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PairUp</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/p6wXbZq/logo.png">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANvzYTTzmi1oWBj2nNdhdvEik4uxGqw4M",
            authDomain: "pairup-66d2c.firebaseapp.com",
            projectId: "pairup-66d2c",
            storageBucket: "pairup-66d2c.firebaseapp.com",
            messagingSenderId: "91688990339",
            appId: "1:91688990339:web:7f8a3cd2c3e3c46cf2cdb6",
            measurementId: "G-9ZHW18RSYD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();
        const provider = new GoogleAuthProvider();
        const imgbbApiKey = '9ac2c16752e7a5a12c20a168ae72e63f';

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login').style.display = 'none';
                loadUserProfile(user);
                loadProfiles(user);
            } else {
                document.getElementById('login').style.display = 'block';
            }
        });

        window.signIn = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                loadUserProfile(user);
                loadProfiles(user);
            } catch (error) {
                console.error("Error signing in: ", error);
            }
        }

        async function loadUserProfile(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('profileName').innerText = data.name;
                document.getElementById('profileAge').innerText = calculateAge(data.dob);
                document.getElementById('profileGender').innerText = data.gender;
                document.getElementById('profileLocation').innerText = data.location;
                document.getElementById('profileBio').innerText = data.bio;
                document.getElementById('profileInterests').innerText = data.interests.join(', ');
                document.getElementById('profilePicturePreview').src = data.profilePicture;
                document.getElementById('profileSection').style.display = 'block';
            } else {
                document.getElementById('profileSetup').style.display = 'block';
            }
        }
        
        function calculateAge(dob) {
            const ageDifMs = Date.now() - new Date(dob).getTime();
            const ageDate = new Date(ageDifMs); // miliseconds from epoch
            return Math.abs(ageDate.getUTCFullYear() - 1970);
        }

        window.signOutUser = function() {
            signOut(auth).then(() => {
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('homepage').style.display = 'none';
                document.getElementById('profileSetup').style.display = 'none';
                document.getElementById('login').style.display = 'block';
            }).catch(error => {
                console.error("Error signing out: ", error);
            });
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: linear-gradient(to right, #ff758c, #ff7eb3); color: white; }
        .container { max-width: 400px; margin: auto; padding: 20px; }
        .profile-card { background: white; color: black; border-radius: 15px; padding: 20px; text-align: center; margin: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .profile-card img { border-radius: 50%; width: 100px; height: 100px; object-fit: cover; }
        button { font-size: 16px; padding: 12px 20px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease-in-out; }
        .like { background-color: #28a745; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .like:hover { background-color: #218838; transform: scale(1.1); }
        .dislike { background-color: #dc3545; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .dislike:hover { background-color: #c82333; transform: scale(1.1); }
        .google-btn { background-color: #4285F4; color: white; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .google-btn:hover { background-color: #357ae8; transform: scale(1.1); }
        .circular-image { border-radius: 50%; width: 50px; height: 50px; object-fit: cover; }
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .nav-bar button {
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: #ff7eb3;
            color: white;
        }
        .nav-bar button:hover {
            background-color: #ff4d8d;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container" id="login">
        <h2>Login to PairUp</h2>
        <button class="google-btn" onclick="signIn()">Sign in with Google</button>
    </div>
    
    <div class="nav-bar">
        <button onclick="showSection('homepage')">Home</button>
        <button onclick="showSection('likedProfiles')">Likes</button>
        <button onclick="showSection('chatSection')">Chats</button>
        <button onclick="showSection('profileSection')">Profile</button>
    </div>
    <div class="container" id="homepage" style="display:none;">
        <h2>People You May Like</h2>
        <div id="profiles"></div>
    </div>

    <div class="container" id="likedProfiles" style="display:none;">
        <h2>Profiles Who Liked You</h2>
        <div id="likedProfilesContainer"></div>
    </div>
    <div class="container" id="chatSection" style="display:none;">
        <h2>Chats</h2>
        <div id="chatList"></div>
        <div id="chatWindow" style="display:none;">
            <h3 id="chatWith"></h3>
            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fff; color: black;"></div>
            <input type="text" id="messageInput" placeholder="Type a message" style="width: 80%;">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        async function loadChats(user) {
            const chatListContainer = document.getElementById('chatList');
            chatListContainer.innerHTML = '';

            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const chats = userDoc.data().chats || [];

            for (const chat of chats) {
                const chatWithUserDocRef = doc(db, "users", chat.with);
                const chatWithUserDoc = await getDoc(chatWithUserDocRef);
                if (chatWithUserDoc.exists()) {
                    let chatWithUser = chatWithUserDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${chatWithUser.profilePicture}" alt="${chatWithUser.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${chatWithUser.name}</strong><br>
                                     <button onclick="openChat('${chat.with}', '${chatWithUser.name}')">Chat</button>`;
                    chatListContainer.appendChild(div);
                }
            }
        }

        async function openChat(chatWithId, chatWithName) {
            document.getElementById('chatWindow').style.display = 'block';
            document.getElementById('chatWith').innerText = chatWithName;
            document.getElementById('chatMessages').innerHTML = '';

            const chatDocRef = doc(db, "chats", `${auth.currentUser.uid}-${chatWithId}`);
            const chatDoc = await getDoc(chatDocRef);
            if (chatDoc.exists()) {
                const messages = chatDoc.data().messages || [];
                for (const message of messages) {
                    addMessageToChat(message);
                }
            }

            window.sendMessage = async function() {
                const messageInput = document.getElementById('messageInput');
                const newMessage = { from: auth.currentUser.uid, text: messageInput.value, timestamp: Date.now() };
                const chatMessages = (await getDoc(chatDocRef)).data().messages || [];
                chatMessages.push(newMessage);
                await updateDoc(chatDocRef, { messages: chatMessages });
                addMessageToChat(newMessage);
                messageInput.value = '';
            }

            function addMessageToChat(message) {
                const messageDiv = document.createElement('div');
                messageDiv.innerText = `${message.text}`;
                messageDiv.style.textAlign = message.from === auth.currentUser.uid ? 'right' : 'left';
                document.getElementById('chatMessages').appendChild(messageDiv);
            }
        }
    </script>
    <div class="container" id="profileSection" style="display:none;">
        <h2>Your Profile</h2>
        <img id="profilePicturePreview" class="circular-image" src="" alt="Profile Picture"><br><br>
        <strong>Name:</strong> <span id="profileName"></span><br>
        <strong>Age:</strong> <span id="profileAge"></span><br>
        <strong>Gender:</strong> <span id="profileGender"></span><br>
        <strong>Location:</strong> <span id="profileLocation"></span><br>
        <strong>Bio:</strong> <span id="profileBio"></span><br>
        <strong>Interests:</strong> <span id="profileInterests"></span><br><br>
        <button onclick="editProfile()">Edit Profile</button>
        <button onclick="signOutUser()">Sign Out</button>
    </div>

    <div class="container" id="profileSetup" style="display:none;">
        <h2>Tell us about yourself</h2>
        <input type="text" id="name" placeholder="Enter your name"><br><br>
        <input type="number" id="age" placeholder="Enter your age"><br><br>
        <select id="gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select><br><br>
        <input type="text" id="location" placeholder="Your location"><br><br>
        <textarea id="bio" placeholder="Write a short bio"></textarea><br><br>
        <input type="file" id="profilePicture" accept="image/*"><br><br>
        <input type="text" id="interests" placeholder="Your interests (comma separated)"><br><br>
        <button onclick="saveProfile()">Save Profile</button>
    </div>
    <script>
        window.editProfile = function() {
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'block';
        }

        async function saveProfile() {
            const user = auth.currentUser;
            const userDocRef = doc(db, "users", user.uid);

            const name = document.getElementById('name').value;
            const dob = new Date().setFullYear(new Date().getFullYear() - document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value;
            const bio = document.getElementById('bio').value;
            const profilePictureFile = document.getElementById('profilePicture').files[0];
            const interests = document.getElementById('interests').value.split(',');

            let profilePictureUrl = document.getElementById('profilePicturePreview').src;
            if (profilePictureFile) {
                profilePictureUrl = await uploadToImgBB(profilePictureFile);
            }

            await setDoc(userDocRef, { name, dob, gender, location, bio, profilePicture: profilePictureUrl, interests });
            loadUserProfile(user);
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            return data.data.url;
        }

        async function loadUserProfile(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('profileName').innerText = data.name;
                document.getElementById('profileAge').innerText = calculateAge(data.dob);
                document.getElementById('profileGender').innerText = data.gender;
                document.getElementById('profileLocation').innerText = data.location;
                document.getElementById('profileBio').innerText = data.bio;
                document.getElementById('profileInterests').innerText = data.interests.join(', ');
                document.getElementById('profilePicturePreview').src = data.profilePicture;
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('profileSetup').style.display = 'none';
            } else {
                document.getElementById('profileSetup').style.display = 'block';
            }
        }
    </script>
    <script>
        window.like = async function(profileId, userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return;

            let likedProfiles = userDoc.data().likedProfiles || [];
            likedProfiles.push(profileId);

            await updateDoc(userDocRef, { likedProfiles });

            const mutualLike = await checkMutualLike(profileId, userId);
            if (mutualLike) {
                const chatDocRef = doc(db, "chats", `${userId}-${profileId}`);
                const chatDoc = await getDoc(chatDocRef);

                if (!chatDoc.exists()) {
                    await setDoc(chatDocRef, { users: [userId, profileId], messages: [] });
                }
            }
        }

        async function checkMutualLike(profileId, userId) {
            const profileDocRef = doc(db, "users", profileId);
            const profileDoc = await getDoc(profileDocRef);

            if (!profileDoc.exists()) return false;

            const likedProfiles = profileDoc.data().likedProfiles || [];
            return likedProfiles.includes(userId);
        }

        window.dislike = async function(profileId, userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return;

            let dislikedProfiles = userDoc.data().dislikedProfiles || [];
            dislikedProfiles.push(profileId);

            await updateDoc(userDocRef, { dislikedProfiles });

            // Remove disliked profiles from the display for this user
            const profileCard = document.querySelector(`button[onclick="dislike('${profileId}', '${userId}')"]`).parentElement;
            profileCard.remove();
        }
    </script>
    <script>
        async function loadProfiles(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const userGender = userDoc.data().gender;

            document.getElementById('profileSetup').style.display = 'none';
            document.getElementById('homepage').style.display = 'block';

            let oppositeGender = userGender === 'male' ? 'female' : 'male';
            const q = query(collection(db, "users"), where("gender", "==", oppositeGender));
            const querySnapshot = await getDocs(q);

            let profileContainer = document.getElementById('profiles');
            profileContainer.innerHTML = '';

            querySnapshot.forEach(doc => {
                let profile = doc.data();
                let div = document.createElement('div');
                div.className = 'profile-card';
                div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                 <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>
                                 <button class='like' onclick="like('${doc.id}', '${user.uid}')">❤ Like</button>
                                 <button class='dislike' onclick="dislike('${doc.id}', '${user.uid}')">❌ Dislike</button>`;
                profileContainer.appendChild(div);
            });
        }

        async function loadLikedProfiles(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const likedProfiles = userDoc.data().likedProfiles || [];

            let likedProfilesContainer = document.getElementById('likedProfilesContainer');
            likedProfilesContainer.innerHTML = '';

            for (const profileId of likedProfiles) {
                const profileDocRef = doc(db, "users", profileId);
                const profileDoc = await getDoc(profileDocRef);
                if (profileDoc.exists()) {
                    let profile = profileDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>`;
                    likedProfilesContainer.appendChild(div);
                }
            }
        }
    </script>
    <script>
        function showSection(sectionId) {
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('likedProfiles').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
        }
    </script>
</body>
</html>
    <script>
        async function loadChats(user) {
            const chatListContainer = document.getElementById('chatList');
            chatListContainer.innerHTML = '';

            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const chats = userDoc.data().chats || [];

            for (const chat of chats) {
                const chatWithUserDocRef = doc(db, "users", chat.with);
                const chatWithUserDoc = await getDoc(chatWithUserDocRef);
                if (chatWithUserDoc.exists()) {
                    let chatWithUser = chatWithUserDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${chatWithUser.profilePicture}" alt="${chatWithUser.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${chatWithUser.name}</strong><br>
                                     <button onclick="openChat('${chat.with}', '${chatWithUser.name}')">Chat</button>`;
                    chatListContainer.appendChild(div);
                }
            }
        }

        async function openChat(chatWithId, chatWithName) {
            document.getElementById('chatWindow').style.display = 'block';
            document.getElementById('chatWith').innerText = chatWithName;
            document.getElementById('chatMessages').innerHTML = '';

            const chatDocRef = doc(db, "chats", `${auth.currentUser.uid}-${chatWithId}`);
            const chatDoc = await getDoc(chatDocRef);
            if (chatDoc.exists()) {
                const messages = chatDoc.data().messages || [];
                for (const message of messages) {
                    addMessageToChat(message);
                }
            }

            window.sendMessage = async function() {
                const messageInput = document.getElementById('messageInput');
                const newMessage = { from: auth.currentUser.uid, text: messageInput.value, timestamp: Date.now() };
                const chatMessages = (await getDoc(chatDocRef)).data().messages || [];
                chatMessages.push(newMessage);
                await updateDoc(chatDocRef, { messages: chatMessages });
                addMessageToChat(newMessage);
                messageInput.value = '';
            }

            function addMessageToChat(message) {
                const messageDiv = document.createElement('div');
                messageDiv.innerText = `${message.text}`;
                messageDiv.style.textAlign = message.from === auth.currentUser.uid ? 'right' : 'left';
                document.getElementById('chatMessages').appendChild(messageDiv);
            }
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(to right, #ff758c, #ff7eb3);
            color: white;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }
        .profile-card {
            background: white;
            color: black;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .profile-card img {
            border-radius: 50%;
            width: 100px;
            height: 100px;
            object-fit: cover;
        }
        button {
            font-size: 16px;
            padding: 12px 20px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: #ff7eb3;
            color: white;
        }
        button:hover {
            background-color: #ff4d8d;
            transform: scale(1.1);
        }
        .google-btn {
            background-color: #4285F4;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .google-btn:hover {
            background-color: #357ae8;
            transform: scale(1.1);
        }
        .circular-image {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .nav-bar button {
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: #ff7eb3;
            color: white;
        }
        .nav-bar button:hover {
            background-color: #ff4d8d;
            transform: scale(1.1);
        }
    </style>
    <div class="container" id="loadingProfiles" style="display:none;">
        <h2>Loading Profiles...</h2>
        <div id="loadingSpinner" class="spinner"></div>
    </div>

    <style>
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #ff4d8d;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        async function loadProfiles(user) {
            document.getElementById('loadingProfiles').style.display = 'block';
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const userGender = userDoc.data().gender;

            let oppositeGender = userGender === 'male' ? 'female' : 'male';
            const q = query(collection(db, "users"), where("gender", "==", oppositeGender));
            const querySnapshot = await getDocs(q);

            let profileContainer = document.getElementById('profiles');
            profileContainer.innerHTML = '';

            querySnapshot.forEach(doc => {
                let profile = doc.data();
                let div = document.createElement('div');
                div.className = 'profile-card';
                div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                 <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>
                                 <button class='like' onclick="like('${doc.id}', '${user.uid}')">❤ Like</button>
                                 <button class='dislike' onclick="dislike('${doc.id}', '${user.uid}')">❌ Dislike</button>`;
                profileContainer.appendChild(div);
            });

            document.getElementById('loadingProfiles').style.display = 'none';
        }
    </script>
    <div class="container" id="loadingProfiles" style="display:none;">
        <h2>Loading Profiles...</h2>
        <div id="loadingSpinner" class="spinner"></div>
    </div>

    <style>
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #ff4d8d;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        async function loadLikedProfiles(user) {
            document.getElementById('loadingProfiles').style.display = 'block';
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const likedProfiles = userDoc.data().likedProfiles || [];

            let likedProfilesContainer = document.getElementById('likedProfilesContainer');
            likedProfilesContainer.innerHTML = '';

            for (const profileId of likedProfiles) {
                const profileDocRef = doc(db, "users", profileId);
                const profileDoc = await getDoc(profileDocRef);
                if (profileDoc.exists()) {
                    let profile = profileDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>`;
                    likedProfilesContainer.appendChild(div);
                }
            }

            document.getElementById('loadingProfiles').style.display = 'none';
        }
    </script>
    <script>
        window.editProfile = function() {
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'block';
        }

        async function saveProfile() {
            const user = auth.currentUser;
            const userDocRef = doc(db, "users", user.uid);

            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            const dob = new Date().setFullYear(new Date().getFullYear() - age);
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value;
            const bio = document.getElementById('bio').value;
            const profilePictureFile = document.getElementById('profilePicture').files[0];
            const interests = document.getElementById('interests').value.split(',').map(i => i.trim());

            let profilePictureUrl = document.getElementById('profilePicturePreview').src;
            if (profilePictureFile) {
                profilePictureUrl = await uploadToImgBB(profilePictureFile);
            }

            await setDoc(userDocRef, { name, dob, gender, location, bio, profilePicture: profilePictureUrl, interests });
            loadUserProfile(user);
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            return data.data.url;
        }

        async function loadUserProfile(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('profileName').innerText = data.name;
                document.getElementById('profileAge').innerText = calculateAge(data.dob);
                document.getElementById('profileGender').innerText = data.gender;
                document.getElementById('profileLocation').innerText = data.location;
                document.getElementById('profileBio').innerText = data.bio;
                document.getElementById('profileInterests').innerText = data.interests.join(', ');
                document.getElementById('profilePicturePreview').src = data.profilePicture;
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('profileSetup').style.display = 'none';
            } else {
                document.getElementById('profileSetup').style.display = 'block';
            }
        }
    </script>
    <script>
        async function checkMutualLike(profileId, userId) {
            const profileDocRef = doc(db, "users", profileId);
            const profileDoc = await getDoc(profileDocRef);

            if (!profileDoc.exists()) return false;

            const likedProfiles = profileDoc.data().likedProfiles || [];
            return likedProfiles.includes(userId);
        }

        window.like = async function(profileId, userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return;

            let likedProfiles = userDoc.data().likedProfiles || [];
            likedProfiles.push(profileId);

            await updateDoc(userDocRef, { likedProfiles });

            const mutualLike = await checkMutualLike(profileId, userId);
            if (mutualLike) {
                const chatDocRef = doc(db, "chats", `${userId}-${profileId}`);
                const chatDoc = await getDoc(chatDocRef);

                if (!chatDoc.exists()) {
                    await setDoc(chatDocRef, { users: [userId, profileId], messages: [] });
                }
            }
        }
    </script>
    <script>
        window.dislike = async function(profileId, userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return;

            let dislikedProfiles = userDoc.data().dislikedProfiles || [];
            dislikedProfiles.push(profileId);

            await updateDoc(userDocRef, { dislikedProfiles });

            // Remove disliked profiles from the display for this user
            const profileCard = document.querySelector(`button[onclick="dislike('${profileId}', '${userId}')"]`).parentElement;
            profileCard.remove();
        }
    </script>
    <style>
        .footer {
            background-color: #ffffff;
            color: #000000;
            text-align: center;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .footer a {
            color: #ff7eb3;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>

    <div class="footer">
        &copy; 2025 PairUp. All rights reserved. | <a href="https://www.pairup.com/privacy-policy">Privacy Policy</a>
    </div>
    <style>
        .footer {
            background-color: #ff7eb3;
            color: white;
            text-align: center;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .footer a {
            color: #ffffff;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>

    <div class="footer">
        &copy; 2025 PairUp. All rights reserved. | <a href="https://www.pairup.com/privacy-policy">Privacy Policy</a>
    </div>
    <script>
        async function loadProfiles(user) {
            document.getElementById('loadingProfiles').style.display = 'block';
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const userGender = userDoc.data().gender;

            let oppositeGender = userGender === 'male' ? 'female' : 'male';
            const q = query(collection(db, "users"), where("gender", "==", oppositeGender));
            const querySnapshot = await getDocs(q);

            let profileContainer = document.getElementById('profiles');
            profileContainer.innerHTML = '';

            querySnapshot.forEach(doc => {
                let profile = doc.data();
                let div = document.createElement('div');
                div.className = 'profile-card';
                div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                 <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>
                                 <button class='like' onclick="like('${doc.id}', '${user.uid}')">❤ Like</button>
                                 <button class='dislike' onclick="dislike('${doc.id}', '${user.uid}')">❌ Dislike</button>`;
                profileContainer.appendChild(div);
            });

            document.getElementById('loadingProfiles').style.display = 'none';
        }
    </script>
    <div class="container" id="profileSetup" style="display:none;">
        <h2>Tell us about yourself</h2>
        <input type="text" id="name" placeholder="Enter your name"><br><br>
        <input type="number" id="age" placeholder="Enter your age"><br><br>
        <select id="gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select><br><br>
        <input type="text" id="location" placeholder="Your location"><br><br>
        <textarea id="bio" placeholder="Write a short bio"></textarea><br><br>
        <input type="file" id="profilePicture" accept="image/*"><br><br>
        <input type="text" id="interests" placeholder="Your interests (comma separated)"><br><br>
        <button onclick="saveProfile()">Save Profile</button>
    </div>

    <script>
        window.editProfile = function() {
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'block';
        }

        async function saveProfile() {
            const user = auth.currentUser;
            const userDocRef = doc(db, "users", user.uid);

            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            const dob = new Date().setFullYear(new Date().getFullYear() - age);
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value;
            const bio = document.getElementById('bio').value;
            const profilePictureFile = document.getElementById('profilePicture').files[0];
            const interests = document.getElementById('interests').value.split(',').map(i => i.trim());

            let profilePictureUrl = document.getElementById('profilePicturePreview').src;
            if (profilePictureFile) {
                profilePictureUrl = await uploadToImgBB(profilePictureFile);
            }

            await setDoc(userDocRef, { name, dob, gender, location, bio, profilePicture: profilePictureUrl, interests });
            loadUserProfile(user);
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            return data.data.url;
        }

        async function loadUserProfile(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('profileName').innerText = data.name;
                document.getElementById('profileAge').innerText = calculateAge(data.dob);
                document.getElementById('profileGender').innerText = data.gender;
                document.getElementById('profileLocation').innerText = data.location;
                document.getElementById('profileBio').innerText = data.bio;
                document.getElementById('profileInterests').innerText = data.interests.join(', ');
                document.getElementById('profilePicturePreview').src = data.profilePicture;
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('profileSetup').style.display = 'none';
            } else {
                document.getElementById('profileSetup').style.display = 'block';
            }
        }
    </script>
    <script>
        async function loadLikedProfiles(user) {
            document.getElementById('loadingProfiles').style.display = 'block';
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const likedProfiles = userDoc.data().likedProfiles || [];

            let likedProfilesContainer = document.getElementById('likedProfilesContainer');
            likedProfilesContainer.innerHTML = '';

            for (const profileId of likedProfiles) {
                const profileDocRef = doc(db, "users", profileId);
                const profileDoc = await getDoc(profileDocRef);
                if (profileDoc.exists()) {
                    let profile = profileDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>`;
                    likedProfilesContainer.appendChild(div);
                }
            }

            document.getElementById('loadingProfiles').style.display = 'none';
        }
    </script>
    <script>
        window.editProfile = function() {
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'block';
        }

        async function saveProfile() {
            const user = auth.currentUser;
            const userDocRef = doc(db, "users", user.uid);

            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            const dob = new Date().setFullYear(new Date().getFullYear() - age);
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value;
            const bio = document.getElementById('bio').value;
            const profilePictureFile = document.getElementById('profilePicture').files[0];
            const interests = document.getElementById('interests').value.split(',').map(i => i.trim());

            let profilePictureUrl = document.getElementById('profilePicturePreview').src;
            if (profilePictureFile) {
                profilePictureUrl = await uploadToImgBB(profilePictureFile);
            }

            await setDoc(userDocRef, { name, dob, gender, location, bio, profilePicture: profilePictureUrl, interests });
            loadUserProfile(user);
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            return data.data.url;
        }

        async function loadUserProfile(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('profileName').innerText = data.name;
                document.getElementById('profileAge').innerText = calculateAge(data.dob);
                document.getElementById('profileGender').innerText = data.gender;
                document.getElementById('profileLocation').innerText = data.location;
                document.getElementById('profileBio').innerText = data.bio;
                document.getElementById('profileInterests').innerText = data.interests.join(', ');
                document.getElementById('profilePicturePreview').src = data.profilePicture;
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('profileSetup').style.display = 'none';
            } else {
                document.getElementById('profileSetup').style.display = 'block';
            }
        }
    </script>
    <script>
        async function checkMutualLike(profileId, userId) {
            const profileDocRef = doc(db, "users", profileId);
            const profileDoc = await getDoc(profileDocRef);

            if (!profileDoc.exists()) return false;

            const likedProfiles = profileDoc.data().likedProfiles || [];
            return likedProfiles.includes(userId);
        }

        window.like = async function(profileId, userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return;

            let likedProfiles = userDoc.data().likedProfiles || [];
            likedProfiles.push(profileId);

            await updateDoc(userDocRef, { likedProfiles });

            const mutualLike = await checkMutualLike(profileId, userId);
            if (mutualLike) {
                const chatDocRef = doc(db, "chats", `${userId}-${profileId}`);
                const chatDoc = await getDoc(chatDocRef);

                if (!chatDoc.exists()) {
                    await setDoc(chatDocRef, { users: [userId, profileId], messages: [] });
                }

                const chatWithUserDocRef = doc(db, "users", profileId);
                const chatWithUserDoc = await getDoc(chatWithUserDocRef);
                const chatWithUser = chatWithUserDoc.data();

                await updateDoc(userDocRef, {
                    chats: arrayUnion({ with: profileId, name: chatWithUser.name, profilePicture: chatWithUser.profilePicture })
                });

                await updateDoc(chatWithUserDocRef, {
                    chats: arrayUnion({ with: userId, name: userDoc.data().name, profilePicture: userDoc.data().profilePicture })
                });
            }
        }
    </script>
    <script>
        window.dislike = async function(profileId, userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return;

            let dislikedProfiles = userDoc.data().dislikedProfiles || [];
            dislikedProfiles.push(profileId);

            await updateDoc(userDocRef, { dislikedProfiles });

            // Remove disliked profiles from the display for this user
            const profileCard = document.querySelector(`button[onclick="dislike('${profileId}', '${userId}')"]`).parentElement;
            profileCard.remove();
        }
    </script>
    <style>
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .nav-bar button {
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: #ff7eb3;
            color: white;
        }
        .nav-bar button:hover {
            background-color: #ff4d8d;
            transform: scale(1.1);
        }
    </style>

    <div class="nav-bar">
        <button onclick="showSection('homepage')">Home</button>
        <button onclick="showSection('likedProfiles')">Likes</button>
        <button onclick="showSection('chatSection')">Chats</button>
        <button onclick="showSection('profileSection')">Profile</button>
    </div>

    <script>
        function showSection(sectionId) {
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('likedProfiles').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
        }
    </script>
    <script>
        async function loadChats(user) {
            const chatListContainer = document.getElementById('chatList');
            chatListContainer.innerHTML = '';

            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const chats = userDoc.data().chats || [];

            for (const chat of chats) {
                const chatWithUserDocRef = doc(db, "users", chat.with);
                const chatWithUserDoc = await getDoc(chatWithUserDocRef);
                if (chatWithUserDoc.exists()) {
                    let chatWithUser = chatWithUserDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${chatWithUser.profilePicture}" alt="${chatWithUser.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${chatWithUser.name}</strong><br>
                                     <button onclick="openChat('${chat.with}', '${chatWithUser.name}')">Chat</button>`;
                    chatListContainer.appendChild(div);
                }
            }
        }

        async function openChat(chatWithId, chatWithName) {
            document.getElementById('chatWindow').style.display = 'block';
            document.getElementById('chatWith').innerText = chatWithName;
            document.getElementById('chatMessages').innerHTML = '';

            const chatDocRef = doc(db, "chats", `${auth.currentUser.uid}-${chatWithId}`);
            const chatDoc = await getDoc(chatDocRef);
            if (chatDoc.exists()) {
                const messages = chatDoc.data().messages || [];
                for (const message of messages) {
                    addMessageToChat(message);
                }
            }

            window.sendMessage = async function() {
                const messageInput = document.getElementById('messageInput');
                const newMessage = { from: auth.currentUser.uid, text: messageInput.value, timestamp: Date.now() };
                const chatMessages = (await getDoc(chatDocRef)).data().messages || [];
                chatMessages.push(newMessage);
                await updateDoc(chatDocRef, { messages: chatMessages });
                addMessageToChat(newMessage);
                messageInput.value = '';
            }

            function addMessageToChat(message) {
                const messageDiv = document.createElement('div');
                messageDiv.innerText = `${message.text}`;
                messageDiv.style.textAlign = message.from === auth.currentUser.uid ? 'right' : 'left';
                document.getElementById('chatMessages').appendChild(messageDiv);
            }
        }
    </script>
    <style>
        .container {
            max-width: 700px;
            margin: auto;
            padding: 20px;
        }
        .profile-card {
            background: white;
            color: black;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .profile-card img {
            border-radius: 50%;
            width: 100px;
            height: 100px;
            object-fit: cover;
        }
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .nav-bar button {
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: #ff7eb3;
            color: white;
        }
        .nav-bar button:hover {
            background-color: #ff4d8d;
            transform: scale(1.1);
        }
        button {
            font-size: 16px;
            padding: 12px 20px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: #ff7eb3;
            color: white;
        }
        button:hover {
            background-color: #ff4d8d;
            transform: scale(1.1);
        }
        .google-btn {
            background-color: #4285F4;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .google-btn:hover {
            background-color: #357ae8;
            transform: scale(1.1);
        }
        .circular-image {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
    </style>
    <script>
        async function loadProfiles(user) {
            document.getElementById('loadingProfiles').style.display = 'block';
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const userGender = userDoc.data().gender;

            let oppositeGender = userGender === 'male' ? 'female' : 'male';
            const q = query(collection(db, "users"), where("gender", "==", oppositeGender));
            const querySnapshot = await getDocs(q);

            let profileContainer = document.getElementById('profiles');
            profileContainer.innerHTML = '';

            querySnapshot.forEach(doc => {
                let profile = doc.data();
                let div = document.createElement('div');
                div.className = 'profile-card';
                div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                 <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>
                                 <button class='like' onclick="like('${doc.id}', '${user.uid}')">❤ Like</button>
                                 <button class='dislike' onclick="dislike('${doc.id}', '${user.uid}')">❌ Dislike</button>`;
                profileContainer.appendChild(div);
            });

            document.getElementById('loadingProfiles').style.display = 'none';
        }
    </script>
    <script>
        async function loadLikedProfiles(user) {
            document.getElementById('loadingProfiles').style.display = 'block';
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const likedProfiles = userDoc.data().likedProfiles || [];

            let likedProfilesContainer = document.getElementById('likedProfilesContainer');
            likedProfilesContainer.innerHTML = '';

            for (const profileId of likedProfiles) {
                const profileDocRef = doc(db, "users", profileId);
                const profileDoc = await getDoc(profileDocRef);
                if (profileDoc.exists()) {
                    let profile = profileDoc.data();
                    let div = document.createElement('div');
                    div.className = 'profile-card';
                    div.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.name}'s profile picture" onerror="this.src='https://via.placeholder.com/100'"><br>
                                     <strong>${profile.name}</strong>, ${calculateAge(profile.dob)}<br>`;
                    likedProfilesContainer.appendChild(div);
                }
            }

            document.getElementById('loadingProfiles').style.display = 'none';
        }
    </script>
</body>
</html>
